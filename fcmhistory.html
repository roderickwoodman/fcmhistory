<!DOCTYPE html>
<html>

<head>

</head>

<body onload="init()">

    <h1>Hello World!</h1>
    <form onsubmit="onUpload()">
        <input id="file-input" type="file" />
        <button type="submit">Upload</button>
    </form>

    <div id="report">

    </div>

    <script>
        let file;
        var content = [];
        let turns = [], zb_turn_limits = [];
        let restaurant = [];
        let uses = [];
        let plays = [];
        let works = [];
        let markets = [];
        let trains = [];
        let hires = [];
        let fires = [];
        let other = [];
        let players = [];

        function init() {
            let input = document.getElementById('file-input');
            input.onchange = e => {
                file = e.target.files[0];
            }
        }

        function onUpload() {
            event.preventDefault()

            let reader = new FileReader();
            reader.readAsText(file, 'UTF-8');
            reader.onload = readerEvent => {
                let file_content = readerEvent.target.result;
                parseContent(file_content);
                displayData();
            }
        }

        function parseContent(file_content) {
            let fc = JSON.parse(JSON.stringify(file_content));
            var lines = fc.split(/[\r\n]+/g);
            const timestamp_regex = /^[0-9]{4}[\/][0-9]{2}[\/][0-9]{2}/g;
            const turns_regex = /Start of turn/g;
            const restaurant_regex = /restaurant/g;
            const uses_regex = /uses his\/her team :/g;
            const plays_regex = /(chooses to play|has to play)/g;
            const works_regex = /sends to work/g;
            const markets_regex = /started the marketing campaign/g;
            const trains_regex = /trains :/g;
            const hires_regex = /hires :/g;
            const fires_regex = /fires/g;
            let messages = [];
            let last_message = {
                body: []
            };
            lines.forEach(function(line, idx) {
                content.push(line);
                if (timestamp_regex.test(line)) {
                    messages.push(last_message);
                    last_message = {
                        timestamp: line,
                        body: []
                    }
                } else {
                    last_message['body'].push(line);
                    if (turns_regex.test(line)) {
                        turns.push(idx);
                    } else if (restaurant_regex.test(line)) {
                        restaurant.push(idx);
                    } else if (uses_regex.test(line)) {
                        uses.push(idx);
                    } else if (plays_regex.test(line)) {
                        plays.push(idx);
                    } else if (works_regex.test(line)) {
                        works.push(idx);
                    } else if (markets_regex.test(line)) {
                        markets.push(idx);
                    } else if (trains_regex.test(line)) {
                        trains.push(idx);
                    } else if (hires_regex.test(line)) {
                        hires.push(idx);
                    } else if (fires_regex.test(line)) {
                        fires.push(idx);
                    } else {
                        other.push(idx);
                    }
                }
            })
            // console.log('CONTENT:', content);
            plays.forEach(function(play_idx) {
                let new_player = content[parseInt(play_idx)].split(' ')[0];
                if (!players.includes(new_player)) {
                    players.push(new_player);
                }
            })

            let prev_min = 0;
            // turns.forEach(function(turn_idx) {
            for (let t=0; t<turns.length-1; t++) {
                let turn_idx = parseInt(turns[t]);
                let new_turn_msg = content[turn_idx].split(' ')
                let this_turn_num = parseInt(new_turn_msg[new_turn_msg.length - 1])
                let new_turn_limits = {
                    start: turn_idx,
                }
                zb_turn_limits.push(new_turn_limits);
                if (t !== 0) {
                    zb_turn_limits[t-1].end = turn_idx - 1;
                }
                zb_turn_limits[zb_turn_limits.length - 1].end = content.length - 1;
            }
            console.log(zb_turn_limits)


            // console.log('ALL MESSAGES:', messages);
            console.log('LINES=' + lines.length + ' MESSAGES=' + messages.length);
            // console.log('content.length:',content.length);
            // console.log('turns:',turns);
            // console.log('restaurant:',restaurant);
            // console.log('uses:',uses);
            // console.log('plays:',plays);
            // console.log('works:',works);
            // console.log('markets:',markets);
            // console.log('trains:',trains);
            // console.log('hires:',hires);
            // console.log('fires:',fires);
            // console.log('other:',other);
            console.log('players:',players);
            console.log('turns='+turns.length
                +' restaurant='+restaurant.length
                +' uses='+uses.length
                +' plays='+plays.length
                +' works='+works.length
                +' markets='+markets.length
                +' trains='+trains.length
                +' hires='+hires.length
                +' fires='+fires.length
                +' other='+other.length
                +' players='+players.length)
        }

        function displayData() {
            let num_players = players.length;

            let report = document.getElementById('report');
            let new_row = document.createElement('div');
            for (let player of players) {
                let new_cell = document.createElement('div');
                new_cell.innerHTML = player;
                new_row.appendChild(new_cell);
            }
            report.appendChild(new_row);
        }

    </script>
</body>

</html>