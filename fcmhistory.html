<!DOCTYPE html>
<html>

<head>

</head>

<body onload="init()">
    <h1>Hello World!</h1>
    <form onsubmit="onUpload()">
        <input id="file-input" type="file" />
        <button type="submit">Upload</button>
    </form>

    <script>
        let file;
        var file_content;
        var content;

        function init() {
            let input = document.getElementById('file-input');
            input.onchange = e => {
                file = e.target.files[0];
            }
        }

        function onUpload() {
            event.preventDefault()

            let reader = new FileReader();
            reader.readAsText(file, 'UTF-8');
            reader.onload = readerEvent => {
                file_content = readerEvent.target.result;
                parseContent();
            }
        }

        function parseContent() {
            content = JSON.parse(JSON.stringify(file_content));
            var lines = content.split(/[\r\n]+/g);
            const timestamp_regex = /^[0-9]{4}[\/][0-9]{2}[\/][0-9]{2}/g;
            const turns_regex = /Start of turn/g;
            const restaurant_regex = /restaurant/g;
            const uses_regex = /uses his\/her team :/g;
            const plays_regex = /(chooses to play|has to play)/g;
            const works_regex = /sends to work/g;
            const markets_regex = /started the marketing campaign/g;
            const trains_regex = /trains :/g;
            const hires_regex = /hires :/g;
            const fires_regex = /fires/g;
            let messages = [];
            let last_message = {
                body: []
            };
            let turns = [];
            let restaurant = [];
            let uses = [];
            let plays = [];
            let works = [];
            let markets = [];
            let trains = [];
            let hires = [];
            let fires = [];
            let other = [];
            lines.forEach(function(line, idx) {
                if (timestamp_regex.test(line)) {
                    messages.push(last_message);
                    last_message = {
                        timestamp: line,
                        body: []
                    }
                } else {
                    last_message['body'].push(line);
                    if (turns_regex.test(line)) {
                        turns.push(idx);
                    } else if (restaurant_regex.test(line)) {
                        restaurant.push(idx);
                    } else if (uses_regex.test(line)) {
                        uses.push(idx);
                    } else if (plays_regex.test(line)) {
                        plays.push(idx);
                    } else if (works_regex.test(line)) {
                        works.push(idx);
                    } else if (markets_regex.test(line)) {
                        markets.push(idx);
                    } else if (trains_regex.test(line)) {
                        trains.push(idx);
                    } else if (hires_regex.test(line)) {
                        hires.push(idx);
                    } else if (fires_regex.test(line)) {
                        fires.push(idx);
                    } else {
                        other.push(idx);
                    }
                }
            })
            console.log('CONTENT:', content);
            let players = [];
            plays.forEach(function(play_idx) {
                let new_player = content[play_idx].split(' ')[0];
                if (!players.includes(new_player)) {
                    players.push(new_player);
                }
            })
            // console.log('ALL MESSAGES:', messages);
            console.log('LINES=' + lines.length + ' MESSAGES=' + messages.length);
            console.log('content.length:',content.length);
            console.log('turns_idx:',turns);
            console.log('turns_idx[0]:',turns[0]);
            let content_idx = turns[0];
            console.log('typeof content:',typeof content);
            console.log('content[133]:',content[133]);
            // console.log('content[turn_idx[0]]:',content[content_idx]);
            // console.log('restaurant:',restaurant);
            // console.log('uses:',uses);
            // console.log('plays:',plays);
            // console.log('works:',works);
            // console.log('markets:',markets);
            console.log('trains:',trains);
            console.log('hires:',hires);
            // console.log('fires:',fires);
            // console.log('other:',other);
            console.log('players:',players);
            console.log('turns='+turns.length
                +' restaurant='+restaurant.length
                +' uses='+uses.length
                +' plays='+plays.length
                +' works='+works.length
                +' markets='+markets.length
                +' trains='+trains.length
                +' hires='+hires.length
                +' fires='+fires.length
                +' other='+other.length
                +' players='+players.length)
        }

    </script>
</body>

</html>